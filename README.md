# ä½¿ç”¨next.jsæ­å»ºä¸€ä¸ªå…è´¹çš„åšå®¢ç½‘ç«™
ä½ å¥½ï¼è¿™æ˜¯æˆ‘ç”¨Next.jsæ­å»ºçš„ç¬¬ä¸€ä¸ªé¡¹ç›®[blogsğŸ’¡](https://blogs-sable-zeta.vercel.app)ï¼Œè®¿é—®ğŸªœ[åŸä½œè€…è§†é¢‘åœ°å€](https://www.youtube.com/watch?v=y7JCnfbETPs)
![alt text](image.png)

>å®Œæˆé¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æŒæ¡äº† `react`ï¼Œ`next.js`ï¼Œ`typeScript`ï¼Œ`tailwindcss`ï¼Œ[`prisma(æ•°æ®åº“)`](https://www.prisma.io/docs/orm/more/help-and-troubleshooting/help-articles/nextjs-prisma-client-dev-practices) [`kinde(ç™»å½•æˆæƒ)`](https://kinde.com)ï¼Œ[`vercel(éƒ¨ç½²)`](https://vercel.com/)çš„éƒ¨åˆ†çŸ¥è¯†ğŸ»
>æ­å»ºéƒ¨ç½²è¿‡ç¨‹æˆ‘æ¢³ç†å¹¶æ€»ç»“æˆäº†æ–‡æ¡£ï¼Œå¸Œæœ›ä½ èƒ½å–œæ¬¢ ~

## ä¸€. æ­å»ºè¿‡ç¨‹
### 1. åˆ›å»ºå¹¶åˆå§‹åŒ–é¡¹ç›®
##### 1.1 åˆ›å»ºä¸€ä¸ª`my-blogs`çš„æ–‡ä»¶å¤¹ï¼Œåœ¨`my-blogs`ä¸­åˆ›å»ºnext.jsåº”ç”¨ï¼š
```
npx create-next-app@14.2.3 . 
```
æˆ–æœ€æ–°ç‰ˆæœ¬ã€‚
```
npx create-next-app@latest .
```
é€‰æ‹©çš„ä¸€äº›é…ç½®ã€‚
```
âˆš Would you like to use TypeScript? ...  Yes
âˆš Would you like to use ESLint? ...  Yes
âˆš Would you like to use Tailwind CSS? ... Yes
âˆš Would you like to use `src/` directory? ...  Yes
âˆš Would you like to use App Router? (recommended) ...  Yes
âˆš Would you like to customize the default import alias (@/*)? ... No
```
##### 1.2 åˆå§‹åŒ–éƒ¨åˆ†æ–‡ä»¶ï¼š
```tsx
// src\app\page.tsx 
export default function Page() {
Â  return (
Â  Â  <div>
Â  Â  Â  Page
Â  Â  </div>
Â  )
}
```

```css
/* src\app\globals.css */
@tailwind base;
@tailwind components;
@tailwind utilities;
```
### 2. ç»„ä»¶åŒ–ï¼Œå¸ƒå±€ï¼Œå“åº”å¼å®¹å™¨ï¼Œé¦–é¡µï¼Œåº•éƒ¨ï¼Œå¤´éƒ¨å®ç°
> - å¯¹next.jsé¡¹ç›®ç»“æ„ä¸ç†Ÿæ‚‰å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ [Project Structure](https://nextjs.org/docs/getting-started/project-structure)ã€‚
> - åœ¨ç¼–å†™tailwindcssæ—¶æ¨èæ’ä»¶ï¼šTailwind CSS IntelliSenseï¼ŒTailwind Snippetsã€‚
##### 2.1 ç»„ä»¶åŒ–ï¼š
å°†å“åº”å¼å®¹å™¨ï¼Œå¤´éƒ¨ï¼Œåº•éƒ¨ç‹¬ç«‹æˆç»„ä»¶ï¼Œåˆ›å»ºç›®å½•ã€‚
```
src\components\container.tsx
src\components\header.tsx
src\components\footer.tsx
```
##### 2.2 å¸ƒå±€ï¼š
```tsx
// src\app\layout.tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import Header from "../components/header";
import Footer from "../components/footer";
import Container from "../components/container";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] }); //ç½‘é¡µå­—ä½“

export const metadata: Metadata = { //é™æ€å…ƒæ•°æ®
Â  title: "My Posts",
Â  description: "Generated by create next app",
};

export default function RootLayout({
Â  children,
}: Readonly<{
Â  children: React.ReactNode;
}>) {
Â  return (
Â  Â  <html lang="en">
Â  Â  Â  <body className={`${inter.className} bg-zinc-100 text-zinc-900 `}>
Â  Â  Â  Â  <Container>
Â  Â  Â  Â  Â  <Header/>
Â  Â  Â  Â  Â  {children}
Â  Â  Â  Â  Â  <Footer/>
Â  Â  Â  Â  </Container>
Â  Â  Â  </body>
Â  Â  </html>
Â  );
}
```
##### 2.3 å“åº”å¼å®¹å™¨ï¼š
```tsx
// src\component\container.tsx
export default function Container({ children }: Readonly<{ children: React.ReactNode }>) {
Â  Â  return (
Â  Â  Â  Â  <div className="max-w-[1100px] mx-auto bg-white flex flex-col min-h-screen border-l border-r">
Â  Â  Â  Â  Â  Â  {children}
Â  Â  Â  Â  </div>
Â  Â  )
}
```
##### 2.4 é¦–é¡µï¼š
```tsx
// src\app\page.tsx
export default function Page() {
Â  return (
Â  Â  <main className="text-center pt-32 px-5">
Â  Â  Â  <h1 className="text-4xl md:text-5xl font-bold mb-5">æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢ï¼</h1>
Â  Â  Â  <p className="max-w-[750px] mx-auto leading-8">
Â  Â  Â  Â  Lorem ipsum dolor sit amet consectetur
Â  Â  Â  Â  adipisicing elit. Ducimus,a
Â  Â  Â  Â  natus? Dolores veritatis perferendis
Â  Â  Â  Â  non doloribus numquam praesentium
Â  Â  Â  Â  aliquid tempora qui similique,
Â  Â  Â  Â  exercitationem distinctio labore culpa
Â  Â  Â  Â  nam natus consequuntur rem!
Â  Â  Â  </p>
Â  Â  </main>
Â  )
}
```
##### 2.5 åº•éƒ¨ï¼š
```tsx
// src\component\footer.tsx
export default function Footer() {
Â  Â  return (
Â  Â  Â  Â  /* å½“å‰Footeræ˜¯åœ¨ä¸€ä¸ªå‚ç›´æ–¹å‘çš„Flexboxå®¹å™¨ä¸­ï¼Œmt-auto (margin-top:auto),å¯ä»¥å°†footeræ¨åˆ°å®¹å™¨çš„åº•éƒ¨ã€‚ */
Â  Â  Â  Â  <div className="mt-auto text-center text-zinc-400 py-5 px-7 border-t">
Â  Â  Â  Â  Â  Â  <small>&copy; 2024. All Rights Reserved.</small>
Â  Â  Â  Â  </div>
Â  Â  )
}
```
##### 2.6 å¤´éƒ¨ï¼š
>Imageæ ‡ç­¾ä¸­srcæ”¾çš„åœ°å€å¯èƒ½ä¼šå‡ºç°==next-image-unconfigured-host==æç¤ºï¼ŒåŸå› åœ¨next.jså®˜æ–¹æ–‡æ¡£å¯ä»¥æ‰¾åˆ°[`next/image` Un-configured Host](https://nextjs.org/docs/messages/next-image-unconfigured-host)ï¼Œè§£å†³æ–¹æ³•æ˜¯åœ¨next.config.mjsä¸­å¢åŠ Imageé…ç½®ã€‚

```js
// next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
Â  Â  images: {
Â  Â  Â  Â  remotePatterns: [
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  protocol: 'https',
Â  Â  Â  Â  Â  Â  Â  Â  hostname: 'bytegrad.com'
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  ]
Â  Â  }
};
export default nextConfig;
```

```tsx
// src\component\header.tsx
'use client' //å½“å‰é¡µé¢æ˜¯å®¢æˆ·ç«¯ç»„ä»¶
import Image from "next/image" //next.jsæä¾›çš„imageç»„ä»¶
import Link from "next/link"; //next.jsæä¾›çš„è·¯ç”±ç»„ä»¶
import { usePathname } from "next/navigation"; //é€šè¿‡usePathnameè·å–å½“å‰é¡µé¢è·¯ç”±åœ°å€
const navLinks = [
Â  Â  {
Â  Â  Â  Â  href: '/',
Â  Â  Â  Â  label: 'Home'
Â  Â  },
Â  Â  {
Â  Â  Â  Â  href: "/posts",
Â  Â  Â  Â  label: "Posts"
Â  Â  },
Â  Â  {
Â  Â  Â  Â  href: '/create-post',
Â  Â  Â  Â  label: "Create post"
Â  Â  }
]
export default function Header() {
Â  Â  const pathname = usePathname();
Â  Â  return (
Â  Â  Â  Â  <header className="flex justify-between items-center py-4 Â px-7 border-b">
Â  Â  Â  Â  Â  Â  <Link href='/'>
Â  Â  Â  Â  Â  Â  Â  Â  <Image
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src="https://bytegrad.com/course-assets/youtube/example-logo.png"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt='logo'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="w-[35px] h-[35px]"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width='35'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height='35'
Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  </Link>
Â  Â  Â  Â  Â  Â  <nav>
Â  Â  Â  Â  Â  Â  Â  Â  <ul className="flex gap-x-5 text-[14px]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navLinks.map((link) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li key={link.href}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Link
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className={`font-bold ${pathname === link.href ? 'text-zinc-900' : "text-zinc-400"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  href={link.href}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {link.label}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </Link>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  </header>
Â  Â  )
}
```
### 3. Postsé¡µé¢ï¼Œé€šè¿‡åŠ¨æ€è·¯ç”±è¿›å…¥postè¯¦æƒ…ï¼ŒCreate Posté¡µé¢
##### 3.1 åˆ›å»ºpostsé¡µé¢ï¼ˆæ–‡æ¡£ [Pages](https://nextjs.org/docs/app/building-your-application/routing/pages)ï¼‰
ç‚¹å‡»æ ‡é¢˜è¿›å…¥è¯¦æƒ…é¡µé¢æ—¶ï¼Œé€šè¿‡æ ‡é¢˜å¯¹åº”çš„idè¿›å…¥åˆ°å­è·¯ç”±é¡µé¢ ``/posts/${post.id}``,æ¯æ¬¡ç‚¹å‡»æ ‡é¢˜çš„idéƒ½æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦ç”¨åˆ°åŠ¨æ€è·¯ç”±ã€‚
```tsx
// src\app\posts\page.tsx
import Link from "next/link";

export default async function Posts() {
Â  Â  const response = await fetch('https:dummyjson.com/posts?limit=10');
Â  Â  const { posts } = await response.json()
Â  Â  return (
Â  Â  Â  Â  <main className="text-center pt-16 px-5">
Â  Â  Â  Â  Â  Â  <h1 className="text-4xl md:text-5xl font-bold mb-5">all posts</h1>
Â  Â  Â  Â  Â  Â  <ul >
Â  Â  Â  Â  Â  Â  Â  Â  {posts.map((post: { id: number, title: string }) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li key={post.id} className="mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Link href={`/posts/${post.id}`} className="text-2xl font-bold">{post.title}</Link>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </main>
Â  Â  )
}


```
##### 3.2 é€šè¿‡ [åŠ¨æ€è·¯ç”±](https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes)è¿›å…¥postè¯¦æƒ…
```tsx 
// src/app/posts/[id]/page.tsx
export default async function Page({ params }: { params: { id: string } }) {
Â  Â  const response = await fetch(`https://dummyjson.com/posts/${params.id}`);
Â  Â  const post = await response.json();
Â  Â  return (
Â  Â  Â  Â  <main className="px-7 pt-24 text-center">
Â  Â  Â  Â  Â  Â  <h1 className="text-5xl font-semibold mb-7">{post.title}</h1>
Â  Â  Â  Â  Â  Â  <p className="max-w-[700px] mx-auto">{post.body}</p>
Â  Â  Â  Â  </main>
Â  Â  )
}
```
è¿™æ ·ï¼Œå°±å¯ä»¥åŠ¨æ€è·å–åˆ°æ¯ä¸ªpostsæ ‡é¢˜å¯¹åº”çš„å†…å®¹äº†ã€‚æ­¤æ—¶ä¼šæœ‰ä¸€äº›å°é—®é¢˜ï¼š1.idä¸å­˜åœ¨æ—¶å¦‚ä½•å¤„ç†ã€‚2.è¯¦æƒ…é¡µé¢æ¸²æŸ“ç­‰å¾…æ—¶å¡é¡¿ã€‚ ä¼˜åŒ–ï¼šåŠ å…¥404é¡µé¢ï¼Œloadingé¡µé¢ã€‚
```tsx
// src/app/posts/[id]/page.tsx
import { notFound } from "next/navigation";
export default async function Page({ params }: { params: { id: string } }) {
	await new Promise((resolve) => setTimeout(resolve, 1000));//ä¸ä¼šç«‹å³å®Œæˆã€‚ä¼šç­‰å¾…1ç§’é’Ÿåè°ƒç”¨resolveå‡½æ•°
Â  Â  const response = await fetch(`https://dummyjson.com/posts/${params.id}`);
Â  Â  const post = await response.json();
Â  Â  //idä¸å­˜åœ¨ï¼Œè·³è½¬åˆ°404é¡µé¢
Â  Â  if (!post.id) { 
Â  Â  Â  Â  notFound();
Â  Â  }
Â  Â  return (
Â  Â  Â  Â  <main className="px-7 pt-24 text-center">
Â  Â  Â  Â  Â  Â  <h1 className="text-5xl font-semibold mb-7">{post.title}</h1>
Â  Â  Â  Â  Â  Â  <p className="max-w-[700px] mx-auto">{post.body}</p>
Â  Â  Â  Â  </main>
Â  Â  )
}
```

```tsx
// src/app/posts/[id]/not-found.tsx
export default function NotFound() {
Â  Â  return (
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  No post found for that id.
Â  Â  Â  Â  </div>
Â  Â  )
}
```

```tsx
// src/app/posts/[id]/loading.tsx
export default function Loading() {
Â  Â  return (
Â  Â  Â  Â  <div className="text-center mt-5">
Â  Â  Â  Â  Â  Â  Loading...
Â  Â  Â  Â  </div>
Â  Â  )
}
```
æœ€åå°†Postsä¸­æ ‡é¢˜åˆ—è¡¨ç‹¬ç«‹æˆå•ç‹¬çš„ç»„ä»¶ã€‚
```tsx
// src/components/posts-list.tsx
import Link from "next/link";
export default async function PostsList() {
Â  Â  const response = await fetch('https:dummyjson.com/posts?limit=10');
Â  Â  const { posts } = await response.json()
Â  Â  return (
Â  Â  Â  Â  <ul >
Â  Â  Â  Â  Â  Â  {posts.map((post: { id: number, title: string }) => (
Â  Â  Â  Â  Â  Â  Â  Â  <li key={post.id} className="mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Link href={`/posts/${post.id}`} className="text-2xl font-bold">{post.title}</Link>
Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </ul>
Â  Â  )
}
```

```tsx
// src/app/posts/page.tsx
import PostsList from "@/components/posts-list";
import { Suspense } from "react";
export default function Posts() {
Â  Â  return (
Â  Â  Â  Â  <main className="text-center pt-16 px-5">
Â  Â  Â  Â  Â  Â  <h1 className="text-4xl md:text-5xl font-bold mb-5">all posts</h1>
Â  Â  Â  Â  Â  Â  {/* å½“uiå°šæœªåŠ è½½æ—¶æ˜¾ç¤ºloading */}
Â  Â  Â  Â  Â  Â  <Suspense fallback="Loading...">
Â  Â  Â  Â  Â  Â  Â  Â  <PostsList />
Â  Â  Â  Â  Â  Â  </Suspense>
Â  Â  Â  Â  </main>
Â  Â  )
}
```
##### 3.3 Create Posté¡µé¢
```tsx
// src\app\create-post\page.tsx
import Form from '@/components/form';
export default async function CreatePost() {
Â  Â  return (
Â  Â  Â  Â  <main className="text-center pt-16">
Â  Â  Â  Â  Â  Â  <h1 className='text-4xl md:text-5xl font-bold mb-5'>Create post</h1>
Â  Â  Â  Â  Â  Â  <Form />
Â  Â  Â  Â  </main>
Â  Â  )
}
```

```tsx
// src\components\form.tsx
import { createPost } from "@/actions/actions";
export default function Form() {
Â  Â  return (
Â  Â  Â  Â  <form
	Â  Â  Â  Â  action={createPost}
Â  Â  Â  Â  Â  Â  className="flex flex-col max-w-[400px] mx-auto space-x-2 gap-2 my-10"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  Â  name="title"
Â  Â  Â  Â  Â  Â  Â  Â  type='text'
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Title for new post"
Â  Â  Â  Â  Â  Â  Â  Â  className="border rounded px-3 h-10"
Â  Â  Â  Â  Â  Â  Â  Â  required
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  Â  Â  Â  name="body"
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Body content for new post"
Â  Â  Â  Â  Â  Â  Â  Â  className="border rounded px-3 py-2"
Â  Â  Â  Â  Â  Â  Â  Â  rows={6}
Â  Â  Â  Â  Â  Â  Â  Â  required
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <button className="h-10 bg-blue-500 px-5 rounded text-white">Submit</button>
Â  Â  Â  Â  </form>
Â  Â  )
}
```
### 4. ç”¨[prisma](https://www.prisma.io/docs/orm/more/help-and-troubleshooting/help-articles/nextjs-prisma-client-dev-practices)æ•°æ®åº“å­˜æ”¾æ•°æ®
##### 4.1 å®‰è£…prisma
å®‰è£…ä¾èµ–ã€‚
```
npm i prisma -save-dev
```
åˆå§‹åŒ–æ•°æ®åº“åä¼šåœ¨æ ¹ç›®å½•ç”Ÿæˆä¸€ä¸ª `prisma`æ–‡ä»¶å¤¹å’Œ `.env`æ–‡ä»¶ã€‚
```
npx prisma init --datasource-provider sqlite
```
å®šä¹‰ä¸€ä¸ªPostæ¨¡å‹ã€‚
```prisma
// prisma\schema.prisma

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
Â  provider = "prisma-client-js"
}

datasource db {
Â  provider = "sqlite"
Â  url Â  Â  Â = env("DATABASE_URL")
}

//å®šä¹‰ä¸€ä¸ªpostæ¨¡å‹
model Post {
Â  id Â  Â  Â  Int Â  Â  Â @id @default(autoincrement())
Â  title Â  Â String
Â  body Â  Â  String
Â  createAt DateTime @default(now())
Â  updateAt DateTime @updatedAt
}
```
æ›´æ–°æ•°æ®åº“ï¼ŒæˆåŠŸåprismaæ–‡ä»¶å¤¹å†…ä¼šç”Ÿæˆä¸€ä¸ª`dev.db`æ–‡ä»¶ã€‚
```
npx prisma db push
```
æŸ¥çœ‹æ•°æ®åº“UIï¼ŒæˆåŠŸåè¿›å…¥ http://localhost:5555 ,ç‚¹å‡»postè¿›å…¥æŸ¥çœ‹åˆšæ‰åˆ›å»ºçš„æ•°æ®ã€‚
```
npx prisma studio
```
##### 4.2 ä½¿ç”¨prisma
åœ¨actionsä¸­é…ç½®è¯·æ±‚ã€‚
```ts
// src\actions\actions.ts
"use server";//æœåŠ¡ç«¯ç»„ä»¶
import prisma from "@/lib/db";
export async function createPost(formData:FormData) {
Â  Â  console.log("formData-->","title:",formData.get("title"),"body:",formData.get("body"))
Â  Â  const title = formData.get("title") as string;
Â  Â  const body = formData.get("body") as string;
Â  Â  await prisma.post.create({
Â  Â  Â  Â  data:{
Â  Â  Â  Â  Â  Â  title,
Â  Â  Â  Â  Â  Â  body
Â  Â  Â  Â  }
Â  Â  Â  })
}
```

```ts
// src\lib\db.ts
import { PrismaClient } from '@prisma/client'

const prismaClientSingleton = () => { // åˆ›å»ºä¸€ä¸ªæ–°çš„ Prisma Client å®ä¾‹ï¼Œä»¥ä¾¿åç»­ä¸æ•°æ®åº“äº¤äº’ã€‚
Â  return new PrismaClient()
}

declare const globalThis: {
Â  prismaGlobal: ReturnType<typeof prismaClientSingleton>;
} & typeof global;

const prisma = globalThis.prismaGlobal ?? prismaClientSingleton() // ç¡®ä¿åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­åªæœ‰ä¸€ä¸ª Prisma Client å®ä¾‹ï¼Œé¿å…äº†å¤šä¸ªå®ä¾‹åŒæ—¶å­˜åœ¨å¯¼è‡´çš„è¿æ¥é—®é¢˜

export default prisma

if (process.env.NODE_ENV !== 'production') globalThis.prismaGlobal = prisma // å¦‚æœå½“å‰ç¯å¢ƒä¸æ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œåˆ™å°† prisma å®ä¾‹èµ‹å€¼ç»™ globalThis.prismaGlobal
```
æ­¤æ—¶ï¼Œåœ¨create posté¡µé¢ä¸­è¾“å…¥å†…å®¹å¹¶æäº¤åï¼Œåœ¨ http://localhost:5555 ä¸­æŸ¥çœ‹æ•°æ®æ˜¯å¦å·²ç»å†™å…¥è¿›prismaã€‚
æ¥ä¸‹æ¥å¯¹posts-liståˆ—è¡¨é¡µï¼Œpostè¯¦æƒ…é¡µè·å–æ•°æ®çš„æ–¹æ³•è¿›è¡Œæ”¹é€ ã€‚
```tsx
// src\components\posts-list.tsx
import prisma from "@/lib/db";
import Link from "next/link";

export default async function PostsList() {
Â  Â  await new Promise((resolve) => setTimeout(resolve, 1000));
Â  Â  const posts = await prisma.post.findMany();
Â  Â  return (
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  {posts.map((post) => (
Â  Â  Â  Â  Â  Â  Â  Â  <li key={post.id} className="mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Link href={`/posts/${post.id}`} >{post.title}</Link>
Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </ul>
Â  Â  )
}
```

```tsx
// src\app\posts\[id]\page.tsx
import prisma from "@/lib/db";
import { notFound } from "next/navigation";
export default async function Page({ params }: { params: { id: string } }) {
Â  Â  await new Promise((resolve) => setTimeout(resolve, 1000));//ä¸ä¼šç«‹å³å®Œæˆã€‚ä¼šç­‰å¾…1ç§’é’Ÿåè°ƒç”¨resolveå‡½æ•°
Â  Â  const post = await prisma.post.findUnique({
Â  Â  Â  Â  where: {
Â  Â  Â  Â  Â  Â  id: parseInt(params.id)
Â  Â  Â  Â  }
Â  Â  })
Â  Â  if (!post) {
Â  Â  Â  Â  notFound();
Â  Â  }
Â  Â  return (
Â  Â  Â  Â  <main className="px-7 pt-24 text-center">
Â  Â  Â  Â  Â  Â  <h1 className="text-5xl font-semibold mb-7">{post.title}</h1>
Â  Â  Â  Â  Â  Â  <p className="max-w-[700px] mx-auto">{post.body}</p>
Â  Â  Â  Â  </main>
Â  Â  )
}
```
##### 4.3 ä¼˜åŒ–é¡µé¢æœªåŠæ—¶æ›´æ–°
æ­¤æ—¶æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼šå½“åœ¨create postä¸­åˆ›å»ºæ•°æ®åï¼Œåˆ‡æ¢åˆ°postsé¡µé¢æ—¶ï¼Œæ ‡é¢˜åˆ—è¡¨ä¸­çš„æ•°æ®æ²¡æœ‰æ›´æ–°åˆ°æœ€æ–°åˆ›å»ºçš„æ•°æ®ã€‚[è§£å†³æ–¹æ³•](https://nextjs.org/docs/app/api-reference/functions/revalidatePath)ï¼šæ¯æ¬¡è®¿é—® `/posts` è·¯ç”±æ—¶éƒ½åˆ·æ–°ç¼“å­˜ã€‚
```tsx
// src\sctions\actions.ts
"use server";//æœåŠ¡ç«¯ç»„ä»¶
import prisma from "@/lib/db";
import { revalidatePath } from "next/cache";

export async function createPost(formData:FormData) {
Â  Â  console.log("formData-->","title:",formData.get("title"),"body:",formData.get("body"))
Â  Â  const title = formData.get("title") as string;
Â  Â  const body = formData.get("body") as string;
Â  Â  await prisma.post.create({
Â  Â  Â  Â  data:{
Â  Â  Â  Â  Â  Â  title,
Â  Â  Â  Â  Â  Â  body
Â  Â  Â  Â  }
Â  Â  Â  })
Â  Â  revalidatePath("/posts")//è®¿é—®è¯¥è·¯ç”±çš„æ—¶å€™åˆ·æ–°ç¼“å­˜
}
```
### 5. kindeæˆæƒç™»å½•
##### 5.1 å®‰è£…kindeå’Œé…ç½®
å¦‚æœæˆ‘ä»¬å¸Œæœ›ç™»å½•çš„ç”¨æˆ·æ‰èƒ½è®¿é—®create posté¡µé¢ï¼Œå¯ä»¥ç”¨[kinde](https://kinde.com)è¿›è¡Œç™»å½•æˆæƒã€‚[è§†é¢‘æ•™ç¨‹ 1:14:28](https://www.youtube.com/watch?v=y7JCnfbETPs)
```
1. ç‚¹å‡» start for free
2. ç‚¹å‡» add application
3. è¾“å…¥é¡¹ç›®å é€‰æ‹© Back-end web å save
4. Quick start é€‰æ‹© Next.js å save
5. ç‚¹å‡» Existing codebase åçœ‹åˆ° Set callback URL, Set logout URL ç‚¹å‡» Set
6. ä¸‹è½½ä¾èµ– npm i @kinde-oss/kinde-auth-nextjs
7. ç»§ç»­æ»šåŠ¨é¡µé¢åˆ° Update environment vars å¤åˆ¶ç²˜è´´åˆ°æ ¹éƒ¨å½•ä¸‹.env.localä¸­,æ³¨æ„ï¼šæœªé¿å…æ³„éœ²ä¿¡æ¯ï¼Œè¯·ä¸è¦å°†ç¯å¢ƒå˜é‡ä¸­çš„ä¿¡æ¯æäº¤ï¼›æ£€æŸ¥.gitignoreæ–‡ä»¶
8. ç»§ç»­æ»šåŠ¨é¡µé¢åˆ° API endpoints åˆ›å»ºç›®å½• `src\app\api\auth\[kindeAuth]\route.js`
9. é€‰æ‹© Authentication é€‰æ‹© Social connenctions ä¸­ ç™»å½•çš„æ–¹å¼ å save
```

```
npm i @kinde-oss/kinde-auth-nextjs
```

```js
// src\app\api\auth\[kindeAuth]\route.js
import { handleAuth } from "@kinde-oss/kinde-auth-nextjs/server";
export const GET = handleAuth();
```
##### 5.2 ä½¿ç”¨kinde
éœ€è¦ç”¨åˆ° [ä¸­é—´ä»¶](https://docs.kinde.com/developer-tools/sdks/backend/nextjs-prev-sdk/?r=search#protect-routes-using-middleware),åœ¨æ¯æ¬¡è®¿é—® `Create post` é¡µé¢æ—¶éªŒè¯æ˜¯å¦æœ‰ç™»å½•ä¿¡æ¯ã€‚
```ts
// src\middleware.ts

import {withAuth} from "@kinde-oss/kinde-auth-nextjs/middleware";
import {NextRequest} from 'next/server';

export default function middleware(req:NextRequest) { // å®šä¹‰ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ï¼Œæ¥æ”¶è¯·æ±‚å¯¹è±¡ req
Â  return withAuth(req, {
Â  Â  isReturnToCurrentPage: true // è®¾ç½®é€‰é¡¹ï¼Œè¡¨ç¤ºåœ¨è®¤è¯åè¿”å›å½“å‰é¡µé¢
Â  });
}
export const config = { // å¯¼å‡ºé…ç½®å¯¹è±¡
Â  matcher: ["/create-post"]// è®¾ç½®åŒ¹é…è·¯å¾„ï¼Œåªæœ‰å½“è¯·æ±‚è·¯å¾„ä¸º "/create-post" æ—¶æ‰ä¼šåº”ç”¨è¯¥ä¸­é—´ä»¶
};
```
æ¯æ¬¡`/create-post`é¡µé¢å‘èµ·è¯·æ±‚æ—¶è¿›è¡ŒéªŒè¯æ˜¯å¦ç™»å½•æˆæƒã€‚
```tsx
// src\actions\actions.ts
"use server";//æœåŠ¡ç«¯ç»„ä»¶
import prisma from "@/lib/db";
import { getKindeServerSession } from "@kinde-oss/kinde-auth-nextjs/server";
import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";

export async function createPost(formData:FormData) {
Â  Â  /* æ¯æ¬¡å‘èµ·è¯·æ±‚æ—¶ï¼Œéƒ½è¿›è¡ŒéªŒè¯æ˜¯å¦æˆæƒ */
Â  Â  const {isAuthenticated} = getKindeServerSession();
Â  Â  if(!(await isAuthenticated())){
Â  Â  Â  Â  redirect("/api/auth/login");
Â  Â  }
Â  Â  console.log("formData-->","title:",formData.get("title"),"body:",formData.get("body"))
Â  Â  const title = formData.get("title") as string;
Â  Â  const body = formData.get("body") as string;
Â  Â  await prisma.post.create({
Â  Â  Â  Â  data:{
Â  Â  Â  Â  Â  Â  title,
Â  Â  Â  Â  Â  Â  body
Â  Â  Â  Â  }
Â  Â  Â  })
Â  Â  revalidatePath("/posts")//è®¿é—®è¯¥è·¯ç”±çš„æ—¶å€™åˆ·æ–°ç¼“å­˜
}
```
åŠ å…¥logoutæŒ‰é’®ã€‚
```tsx
// src\app\create-post\page.tsx
import { LogoutLink } from '@kinde-oss/kinde-auth-nextjs/components';
import Form from '@/components/form';

export default async function CreatePost() {
Â  Â  return (
Â  Â  Â  Â  <main className="text-center pt-16">
Â  Â  Â  Â  Â  Â  <h1 className='text-4xl md:text-5xl font-bold mb-5'>Create post</h1>
Â  Â  Â  Â  Â  Â  <Form />
Â  Â  Â  Â  Â  Â  <LogoutLink>logout</LogoutLink>
Â  Â  Â  Â  </main>
Â  Â  )
}
```
==(å¯å¿½ç•¥)== å°†ç¯å¢ƒå˜é‡ç»Ÿä¸€æ”¾å…¥ä¸€ä¸ªæ–‡ä»¶å¤¹å†…ï¼Œå°† `.env.local` ä¸­å†…å®¹å¤åˆ¶ç²˜è´´åˆ° `.env` ä¸­ï¼Œåªä¿ç•™ `.env` , æ³¨æ„è¯·åœ¨.gitignoreä¸­é…ç½®ä¸è¦å°†.envæ–‡ä»¶æäº¤åˆ°è¿œç¨‹ä»“åº“ã€‚
## äºŒ. éƒ¨ç½²è¿‡ç¨‹

>å°†ä»£ç éƒ¨ç½²åˆ° [vercel](https://vercel.com)ï¼šå…ˆæŠŠä»£ç æäº¤åˆ°githubä»“åº“ï¼Œç„¶ååœ¨vercelä¸­å¯¼å…¥é¡¹ç›®è¿›è¡Œéƒ¨ç½²ã€‚ï¼ˆåœ¨é¦–æ¬¡éƒ¨ç½²çš„è¿‡ç¨‹ä¸­ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ã€‚ [è§†é¢‘æ•™ç¨‹1:56:10](https://www.youtube.com/watch?v=y7JCnfbETPs)ï¼‰
##### prismaæ•°æ®åº“é—®é¢˜
åœ¨package.jsonä¸­ `"scripts"` ä¸­åŠ å…¥ã€‚
```
"postinstall":"prisma generate"
```
è¿›å…¥vercelä¸­åˆšæ‰å¯¼å…¥çš„é¡¹ç›®ï¼Œé€‰æ‹©Storge,åˆ›å»ºä¸€ä¸ªç”¨äºç”Ÿäº§çš„æ•°æ®åº“ã€‚
```
- é€‰æ‹© Postgres  å  Create
- Accept --> Create 
- è¿›å…¥æ–°å»ºçš„æ•°æ®åº“ 
- é€‰æ‹©prisma  å¤åˆ¶ç²˜è´´åˆ°æœ¬åœ° schema.prisma ä¸­æ›¿æ¢æ‰ datasource db å¯¹åº”ä»£ç 
- é€‰æ‹©.env.local å¤åˆ¶ç²˜è´´åˆ°æœ¬åœ° .env ä¸­æ›¿æ¢æ‰ DATABASE_URL  
- ç»ˆç«¯å°†æ•°æ®åº“æ¨¡å‹åŒæ­¥åˆ°æ•°æ®åº“ npx prisma db push 
- å†æ¬¡å°†ä»£ç æäº¤åˆ°githubï¼Œæ­¤æ—¶vercelä¼šè‡ªåŠ¨éƒ¨ç½²åˆšæ‰æäº¤çš„ä»£ç ã€‚è‹¥æ²¡æœ‰è‡ªåŠ¨éƒ¨ç½²ä¹Ÿå¯ä»¥ç‚¹è¿›é¡¹ç›®ä¸­é€‰æ‹©Deployments é€‰æ‹© Redeploy é‡æ–°éƒ¨ç½²ï¼Œç»¿ç¯è¡¨ç¤ºéƒ¨ç½²æˆåŠŸ
```
##### ç¯å¢ƒå˜é‡é—®é¢˜
åœ¨é¢„è§ˆé¡¹ç›®æ˜¯ï¼Œåˆ‡æ¢åˆ°posté¡µé¢å‘ç°æ­¤æ—¶postlistæ•°æ®ä¸ºç©ºï¼Œcreate posté¡µé¢æ‰“ä¸å¼€ï¼Œå‘ç°åœ°å€è¿˜æ˜¯æœ¬åœ°çš„ï¼Œæ‰€ä»¥éœ€è¦å°†URLåœ°å€æ›¿æ¢æˆç”Ÿäº§URLåœ°å€ã€‚
```
- é€‰æ‹© Project å¤åˆ¶ Domains ä¸­ ç”Ÿäº§URLåœ°å€
- é€‰æ‹© Settings é€‰æ‹© Environment Variables
- é€‰æ‹© KINDE_SITE_URL ä¿®æ”¹ value æ›¿æ¢æˆ https://ä½ çš„ç”Ÿäº§åœ°å€ å SAVE
- é€‰æ‹© KINDE_POST_LOGOUT_REDIRECT_URL ä¿®æ”¹ value æ›¿æ¢æˆ https://ä½ çš„ç”Ÿäº§åœ°å€ å SAVE
- é€‰æ‹© KINDE_POST_LOGIN_REDIRECT_URL ä¿®æ”¹ value æ›¿æ¢æˆ https://ä½ çš„ç”Ÿäº§åœ°å€/create-post å SAVE
```
è¿˜éœ€è¦åœ¨kindeä¸­é…ç½®é€€å‡ºç™»å½•åé‡å®šå‘åœ°å€ã€‚
```
- è¿›å…¥kindeä¸­ä¹‹å‰å»ºå¥½çš„é¡¹ç›®å†…
- é€‰æ‹© Details
- æ»šåŠ¨è‡³ Allowed callback URLs åŠ å…¥åœ°å€ https://ä½ çš„ç”Ÿäº§åœ°å€/auth/kinde_callback 
- æ»šåŠ¨è‡³ Allowed logout redirect URLs åŠ å…¥åœ°å€ https://ä½ çš„ç”Ÿäº§åœ°å€  å SAVE
```

æœ€åå†éƒ¨ç½²ä¸€æ¬¡ï¼Œç­‰åˆ°Statuså˜ç»¿åï¼Œæ­¤æ—¶ä½ å·²ç»è‡ªå·±æ­å»ºå¹¶éƒ¨ç½²äº†ä½ çš„åšå®¢ğŸ‰ğŸ‰ğŸ‰
å¦‚æœæˆ‘çš„æ–‡æ¡£å¯¹ä½ æœ‰å¸®åŠ©ï¼Œåˆ«å¿˜äº†[Starâ­ï¸~ ](https://github.com/MuscleProgrammerXiao/blogs) æˆ‘ä¼šæ›´åŠ ç§¯æçš„æ›´æ–°ğŸ»